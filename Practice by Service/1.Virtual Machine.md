# Overview

- Create the VM to practice and it will be automatically stopped if it is not used for a short time 15mins
- Basically, the VM will cost the user when the VM having the status running, so it is really useful of we stop the VM when not using. So we can use Automation Account with Runbook to achieve that

=======

# 1. Create the VM

- VM name: main-running-vm-cost
- Group name: long-running-gr
- Cost: 10â€“20$ / months

# 2. Set up the Budget to limit the cost

- Maximum 10$ per month for all Azure resource

# 3. Create the Automation Account

- main-running-vm-cost-auto-stop the same region with VM
- Include Runbook within the script to check the CPU and stop VM at the specific condition

# 4. Turn on Managed Identity for Automation Account

# 5. Grant permission Contributor for that Automation Account

az role assignment create \
 --assignee-object-id <ID> \
 --assignee-principal-type ServicePrincipal \
 --role "Contributor" \
 --scope /subscriptions/<Subscription...>/resourceGroups/long-running-gr

# 6. Import necessary module

- Az.Accounts
- Az.Compute
- Az.Monitor
- Az.Resources

# 7. Create Runbook AutoStopIdleVM within the script to check and stop the VM

# 8. Test the Runbook

# 9. Create the scheduler to automate running Runbook

- That will be run every hour
